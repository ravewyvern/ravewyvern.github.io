<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft Web Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --panel-color: #1a202c;
            --background-color: #2d3748;
            --text-color: #e2e8f0;
            --accent-color: #4299e1;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--panel-color); }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }

        /* Dynamic colors */
        .bg-accent { background-color: var(--accent-color); }
        .hover\:bg-accent-dark:hover { filter: brightness(0.9); }
        .focus\:ring-accent:focus { --tw-ring-color: var(--accent-color); }
        .border-accent { border-color: var(--accent-color); }

        /* Active tab style */
        .tab.active {
            background-color: var(--panel-color);
            border-bottom-color: var(--accent-color);
        }
        /* Toggle switch style */
        .toggle-input:checked ~ .dot { transform: translateX(100%); background-color: white; }
        .toggle-input:checked ~ .block { background-color: var(--accent-color); }

        /* Modal backdrop */
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.7); }
        #settings-modal { z-index: 20; }
        #config-editor-modal, #script-editor-modal { z-index: 30; }

        /* Visual Editor details/summary styling */
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details > summary .summary-arrow { transition: transform 0.2s; }
        details[open] > summary .summary-arrow { transform: rotate(90deg); }
    </style>
</head>
<body class="font-sans antialiased" id="app-body">

<div id="app-container" class="flex flex-col h-screen">
    <!-- Top Bar -->
    <header id="top-bar" class="flex items-center p-2 shadow-md z-10">
        <nav id="tabs-container" class="flex-grow flex items-center space-x-2"></nav>
        <div class="flex items-center space-x-4">
            <span id="connection-status" class="text-sm font-medium">Disconnected</span>
            <button id="settings-btn" class="p-2 rounded-full hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-accent">
                <span class="material-icons">settings</span>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main id="main-content" class="flex-grow p-4 overflow-y-auto"></main>
</div>

<!-- Settings Modal -->
<div id="settings-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center hidden">
    <div id="settings-panel" class="rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
        <div class="flex justify-between items-center p-4 border-b">
            <h2 class="text-xl font-bold">Settings</h2>
            <button id="close-settings-btn" class="p-2 rounded-full hover:bg-gray-700">
                <span class="material-icons">close</span>
            </button>
        </div>
        <div class="p-4 space-y-6 overflow-y-auto">
            <!-- Connection -->
            <section>
                <h3 class="text-lg font-semibold mb-2">Connection</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="ip-input" class="block text-sm font-medium mb-1">IP Address / URL</label>
                        <input type="text" id="ip-input" placeholder="your-ip or ws://your-ip" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-accent focus:outline-none bg-gray-700 border-gray-600">
                    </div>
                    <div>
                        <label for="port-input" class="block text-sm font-medium mb-1">Port</label>
                        <input type="number" id="port-input" placeholder="8080" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-accent focus:outline-none bg-gray-700 border-gray-600">
                    </div>
                    <div class="md:col-span-2">
                        <label for="password-input" class="block text-sm font-medium mb-1">Password</label>
                        <input type="password" id="password-input" placeholder="password" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-accent focus:outline-none bg-gray-700 border-gray-600">
                    </div>
                </div>
                <button id="connect-btn" class="mt-4 w-full bg-accent hover:bg-accent-dark text-white font-bold py-2 px-4 rounded-md transition duration-300">
                    Connect
                </button>
            </section>

            <!-- Configuration -->
            <section>
                <h3 class="text-lg font-semibold mb-2">Configuration</h3>
                <p class="text-sm text-gray-400 mb-2">Use the editors or paste JSON directly. Changes are saved automatically.</p>
                <textarea id="config-input" rows="8" class="w-full p-2 border rounded-md font-mono text-sm bg-gray-900 border-gray-600 focus:ring-2 focus:ring-accent focus:outline-none" placeholder="Paste JSON config here..."></textarea>
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-2 mt-2">
                    <input type="file" id="import-config-input" class="hidden" accept=".json">
                    <label for="import-config-input" class="cursor-pointer text-center bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">Import</label>
                    <button id="export-config-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">Export</button>
                    <button id="visual-editor-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">Visual Editor</button>
                    <button id="reset-config-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">Reset</button>
                </div>
            </section>
        </div>
    </div>
</div>

<!-- Script Editor Modal -->
<div id="script-editor-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center hidden">
    <div class="rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col" style="background-color: var(--panel-color);">
        <h2 id="script-editor-title" class="text-xl font-bold p-4 border-b">Create Script</h2>
        <div class="p-4 space-y-4 overflow-y-auto">
            <div>
                <label for="script-name-input" class="block text-sm font-medium mb-1">Script Name</label>
                <input type="text" id="script-name-input" class="w-full p-2 border rounded-md bg-gray-700 border-gray-600">
            </div>
            <div>
                <label for="script-content-input" class="block text-sm font-medium mb-1">Commands (one per line)</label>
                <textarea id="script-content-input" rows="12" class="w-full p-2 border rounded-md font-mono text-sm bg-gray-900 border-gray-600"></textarea>
            </div>
        </div>
        <div class="flex justify-end p-4 border-t space-x-2">
            <button id="cancel-script-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">Cancel</button>
            <button id="save-script-btn" class="bg-accent hover:bg-accent-dark text-white font-bold py-2 px-4 rounded-md">Save Script</button>
        </div>
    </div>
</div>

<!-- Config Editor Modal -->
<div id="config-editor-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center hidden">
    <div id="config-editor-panel" class="rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col" style="background-color: var(--panel-color);">
        <div class="flex justify-between items-center p-4 border-b">
            <h2 class="text-xl font-bold">Visual Configuration Editor</h2>
        </div>
        <div id="config-editor-content" class="p-4 space-y-6 overflow-y-auto">
            <!-- JS will populate this -->
        </div>
        <div class="flex justify-end p-4 border-t space-x-2">
            <button id="cancel-config-edit-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">Cancel</button>
            <button id="save-config-edit-btn" class="bg-accent hover:bg-accent-dark text-white font-bold py-2 px-4 rounded-md">Save & Apply</button>
        </div>
    </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', () => {
        // =================================================================================
        // --- STATE MANAGEMENT ---
        // =================================================================================
        let socket = null;
        let authed = false;
        let config = {};
        let scripts = {};
        let activeTabId = 'console';
        let consoleHistory = [];
        let editingScriptName = null;
        let tempConfig = {}; // For visual config editor

        const defaultConfig = {
            "theme": { "panelColor": "#1a202c", "backgroundColor": "#2d3748", "textColor": "#e2e8f0", "accentColor": "#4299e1" },
            "tabs": [
                { "id": "console", "name": "Console", "icon": "terminal" },
                { "id": "scripts", "name": "Scripts", "icon": "description" },
                { "id": "showcase", "name": "Showcase", "icon": "smart_toy", "panels": [{ "title": "Component Showcase", "items": [
                            { "type": "text", "content": "Here are examples of all available item types." },
                            { "type": "button", "label": "Say Hello", "command": "/say Hello from a button!" },
                            { "type": "text_input", "label": "Broadcast", "placeholder": "Your message...", "command": "/say %s%" },
                            { "type": "toggle", "label": "Announce Toggles", "on_command": "/say Toggled ON", "off_command": "/say Toggled OFF" },
                            { "type": "dropdown", "options": [{ "label": "Set Time to Day", "command": "/say Setting time to Day" }, { "label": "Set Time to Night", "command": "/say Setting time to Night" }]},
                            { "type": "slider", "label": "Announce a Number", "min": 0, "max": 100, "default": 50, "command": "/say The chosen number is %s%" }
                        ]}]}
            ]
        };

        // =================================================================================
        // --- DOM ELEMENT REFERENCES ---
        // =================================================================================
        const DOMElements = {
            body: document.getElementById('app-body'), topBar: document.getElementById('top-bar'), tabsContainer: document.getElementById('tabs-container'), mainContent: document.getElementById('main-content'), status: document.getElementById('connection-status'),
            settingsBtn: document.getElementById('settings-btn'), settingsModal: document.getElementById('settings-modal'), closeSettingsBtn: document.getElementById('close-settings-btn'), ipInput: document.getElementById('ip-input'), portInput: document.getElementById('port-input'), passwordInput: document.getElementById('password-input'), connectBtn: document.getElementById('connect-btn'),
            configInput: document.getElementById('config-input'), importConfigInput: document.getElementById('import-config-input'), exportConfigBtn: document.getElementById('export-config-btn'), resetConfigBtn: document.getElementById('reset-config-btn'),
            scriptEditorModal: document.getElementById('script-editor-modal'), scriptEditorTitle: document.getElementById('script-editor-title'), scriptNameInput: document.getElementById('script-name-input'), scriptContentInput: document.getElementById('script-content-input'), cancelScriptBtn: document.getElementById('cancel-script-btn'), saveScriptBtn: document.getElementById('save-script-btn'),
            visualEditorBtn: document.getElementById('visual-editor-btn'), configEditorModal: document.getElementById('config-editor-modal'), configEditorContent: document.getElementById('config-editor-content'), cancelConfigEditBtn: document.getElementById('cancel-config-edit-btn'), saveConfigEditBtn: document.getElementById('save-config-edit-btn'),
        };

        // =================================================================================
        // --- INITIALIZATION & DATA HANDLING ---
        // =================================================================================
        function initialize() {
            const savedConfig = localStorage.getItem('minecraftWebConsoleConfig');
            try { config = savedConfig ? JSON.parse(savedConfig) : JSON.parse(JSON.stringify(defaultConfig)); } catch (e) { config = JSON.parse(JSON.stringify(defaultConfig)); }

            const savedScripts = localStorage.getItem('minecraftWebConsoleScripts');
            try { scripts = savedScripts ? JSON.parse(savedScripts) : {}; } catch (e) { scripts = {}; }

            const savedConnection = localStorage.getItem('minecraftWebConsoleConnection');
            if(savedConnection) {
                const {ip, port, password} = JSON.parse(savedConnection);
                DOMElements.ipInput.value = ip; DOMElements.portInput.value = port; DOMElements.passwordInput.value = password;
            }
            activeTabId = config.tabs[0]?.id || 'console';
            renderUI();
        }

        function saveConfig() { localStorage.setItem('minecraftWebConsoleConfig', JSON.stringify(config)); }
        function saveScripts() { localStorage.setItem('minecraftWebConsoleScripts', JSON.stringify(scripts)); }

        // =================================================================================
        // --- UI RENDERING (MAIN APP) ---
        // =================================================================================
        function renderUI() { applyTheme(); renderTabs(); renderContent(); }
        function applyTheme() {
            const theme = config.theme || defaultConfig.theme;
            const root = document.documentElement;
            Object.keys(theme).forEach(key => root.style.setProperty(`--${key.replace(/([A-Z])/g, '-$1').toLowerCase()}`, theme[key]));
            DOMElements.body.style.backgroundColor = 'var(--background-color)'; DOMElements.body.style.color = 'var(--text-color)'; DOMElements.topBar.style.backgroundColor = 'var(--panel-color)';
        }
        function renderTabs() {
            DOMElements.tabsContainer.innerHTML = '';
            config.tabs.forEach(tab => {
                const tabEl = document.createElement('button');
                tabEl.className = `tab flex items-center space-x-2 p-2 border-b-4 transition duration-200 ${activeTabId === tab.id ? 'active' : 'border-transparent hover:bg-gray-700'}`;
                tabEl.dataset.tabId = tab.id;
                tabEl.innerHTML = `<span class="material-icons text-lg">${tab.icon || 'label'}</span><span class="font-medium">${tab.name}</span>`;
                tabEl.onclick = () => { activeTabId = tab.id; renderContent(); renderTabs(); };
                DOMElements.tabsContainer.appendChild(tabEl);
            });
        }
        function renderContent() {
            DOMElements.mainContent.innerHTML = '';
            const tabConfig = config.tabs.find(t => t.id === activeTabId);
            if (!tabConfig) return;
            switch(tabConfig.id) {
                case 'console': renderConsole(); break;
                case 'scripts': renderScripts(); break;
                default: renderCustomTab(tabConfig); break;
            }
        }
        function renderConsole() {
            DOMElements.mainContent.innerHTML = `<div class="flex flex-col h-full"><div id="console-log" class="flex-grow p-2 rounded-md overflow-y-auto whitespace-pre-wrap break-words" style="background-color: var(--panel-color);"></div><div class="mt-2 flex"><input id="console-cmd-input" type="text" class="flex-grow p-2 border rounded-l-md focus:ring-2 focus:ring-accent focus:outline-none bg-gray-700 border-gray-600" placeholder="Enter command..."><button id="console-send-btn" class="bg-accent hover:bg-accent-dark text-white font-bold py-2 px-4 rounded-r-md">Send</button></div></div>`;
            const consoleLog = document.getElementById('console-log');
            consoleHistory.forEach(msg => { const line = document.createElement('div'); line.textContent = msg; consoleLog.appendChild(line); });
            consoleLog.scrollTop = consoleLog.scrollHeight;
            const cmdInput = document.getElementById('console-cmd-input');
            const sendBtn = document.getElementById('console-send-btn');
            const sendConsoleCommand = () => { if (cmdInput.value) { sendCommand(cmdInput.value); cmdInput.value = ''; }};
            cmdInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendConsoleCommand(); });
            sendBtn.addEventListener('click', sendConsoleCommand);
        }
        function renderScripts() {
            let scriptListHtml = Object.keys(scripts).length > 0 ? '' : '<p class="text-gray-400">No scripts created yet.</p>';
            Object.keys(scripts).sort().forEach(name => { scriptListHtml += `<div class="flex items-center justify-between p-3 rounded-md mb-2" style="background-color: var(--panel-color);"><span class="font-mono">${name}</span><div class="flex space-x-2"><button data-script-name="${name}" class="run-script-btn p-2 rounded-md bg-green-600 hover:bg-green-700"><span class="material-icons">play_arrow</span></button><button data-script-name="${name}" class="edit-script-btn p-2 rounded-md bg-gray-600 hover:bg-gray-700"><span class="material-icons">edit</span></button><button data-script-name="${name}" class="delete-script-btn p-2 rounded-md bg-red-600 hover:bg-red-700"><span class="material-icons">delete</span></button></div></div>`; });
            DOMElements.mainContent.innerHTML = `<div class="max-w-4xl mx-auto"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">Scripts</h2><button id="create-script-btn" class="bg-accent hover:bg-accent-dark text-white font-bold py-2 px-4 rounded-md flex items-center space-x-2"><span class="material-icons">add</span><span>Create New Script</span></button></div><div id="script-list">${scriptListHtml}</div></div>`;
        }
        function renderCustomTab(tabConfig) {
            const container = document.createElement('div'); container.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4';
            tabConfig.panels?.forEach(panel => {
                const panelEl = document.createElement('div'); panelEl.className = 'rounded-lg p-4'; panelEl.style.backgroundColor = 'var(--panel-color)';
                let itemsHtml = '';
                panel.items?.forEach((item, index) => {
                    const itemId = `${tabConfig.id}-${panel.title.replace(/\s+/g, '')}-${index}`;
                    switch (item.type) {
                        case 'text': itemsHtml += `<p class="text-gray-300 mb-2">${item.content}</p>`; break;
                        case 'button': itemsHtml += `<button data-command="${item.command}" class="w-full bg-accent hover:bg-accent-dark text-white font-bold py-2 px-4 rounded-md mb-2 command-btn">${item.label}</button>`; break;
                        case 'text_input': itemsHtml += `<div class="flex mb-2"><input type="text" id="${itemId}" data-command-template="${item.command}" class="flex-grow p-2 border rounded-l-md bg-gray-700 border-gray-600 focus:outline-none focus:ring-2 focus:ring-accent" placeholder="${item.placeholder || ''}"><button data-input-id="${itemId}" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-r-md text-input-btn">${item.label || 'Run'}</button></div>`; break;
                        case 'toggle': itemsHtml += `<label for="${itemId}" class="flex items-center justify-between mb-2 cursor-pointer"><span>${item.label}</span><div class="relative"><input type="checkbox" id="${itemId}" class="sr-only toggle-input" data-on-command="${item.on_command}" data-off-command="${item.off_command}"><div class="block bg-gray-600 w-14 h-8 rounded-full"></div><div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition"></div></div></label>`; break;
                        case 'dropdown': let options = item.options.map(opt => `<option value="${opt.command}">${opt.label}</option>`).join(''); itemsHtml += `<div class="flex mb-2"><select id="${itemId}" class="flex-grow p-2 border rounded-l-md bg-gray-700 border-gray-600 focus:outline-none focus:ring-2 focus:ring-accent">${options}</select><button data-select-id="${itemId}" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-r-md dropdown-btn">Run</button></div>`; break;
                        case 'slider': itemsHtml += `<div class="mb-2"><label class="flex justify-between"><span>${item.label}</span><span id="${itemId}-value">${item.default || item.min || 0}</span></label><input type="range" id="${itemId}" min="${item.min || 0}" max="${item.max || 100}" value="${item.default || item.min || 0}" data-command-template="${item.command}" class="w-full slider-input"></div>`; break;
                    }
                });
                panelEl.innerHTML = `<h3 class="text-lg font-bold border-b border-gray-600 pb-2 mb-3">${panel.title}</h3><div class="space-y-3">${itemsHtml}</div>`;
                container.appendChild(panelEl);
            });
            DOMElements.mainContent.appendChild(container);
        }

        // =================================================================================
        // --- WEBSOCKET & COMMAND HANDLING ---
        // =================================================================================
        function updateStatus(text, colorClass = 'text-gray-400') { DOMElements.status.textContent = text; DOMElements.status.className = `text-sm font-medium ${colorClass}`; }
        function logToConsole(message) {
            consoleHistory.push(message);
            if (activeTabId === 'console') {
                const consoleLog = document.getElementById('console-log');
                if (consoleLog) { const line = document.createElement('div'); line.textContent = message; consoleLog.appendChild(line); consoleLog.scrollTop = consoleLog.scrollHeight; }
            }
        }
        function connect() {
            const ip = DOMElements.ipInput.value, port = DOMElements.portInput.value, password = DOMElements.passwordInput.value;
            if (!ip || !port || !password) { alert("Please fill in all connection fields."); return; }
            localStorage.setItem('minecraftWebConsoleConnection', JSON.stringify({ip, port, password}));
            if (socket && socket.readyState === WebSocket.OPEN) socket.close();
            let url = ip;
            if (!url.startsWith('ws://') && !url.startsWith('wss://')) url = `ws://${url}`;
            if (url.split(':').length < 3) url = `${url}:${port}`;
            try { socket = new WebSocket(url); } catch (e) { updateStatus("Invalid URL", 'text-red-400'); logToConsole(`!! Error: Invalid URL format: ${url}`); return; }
            updateStatus('Connecting...', 'text-yellow-400');
            socket.onopen = () => { updateStatus('Authenticating...', 'text-yellow-400'); socket.send("auth:" + password); };
            socket.onmessage = (e) => {
                logToConsole("<< " + e.data);
                if (e.data === "authenticated") { authed = true; updateStatus("Connected", 'text-green-400'); DOMElements.settingsModal.classList.add('hidden'); }
                if (e.data === "auth_failed") { authed = false; updateStatus("Auth Failed", 'text-red-400'); socket.close(); }
            };
            socket.onclose = () => { authed = false; updateStatus("Disconnected", 'text-red-400'); };
            socket.onerror = () => { logToConsole("!! WebSocket Error."); updateStatus("Error", 'text-red-400'); };
        }
        function sendCommand(cmd) {
            if (!authed) { logToConsole("!! Not authenticated."); return; }
            if (!cmd) return;
            socket.send(cmd); logToConsole(">> " + cmd);
        }
        function runScript(scriptName) {
            const commands = scripts[scriptName]?.split('\n').filter(line => line.trim() !== '');
            if (!commands) { logToConsole(`!! Script not found: ${scriptName}`); return; }
            logToConsole(`-- Running script "${scriptName}" --`);
            commands.forEach((cmd, i) => setTimeout(() => sendCommand(cmd), i * 200));
        }

        // =================================================================================
        // --- EVENT LISTENERS (MODALS & DELEGATION) ---
        // =================================================================================
        DOMElements.settingsBtn.addEventListener('click', () => { DOMElements.configInput.value = JSON.stringify(config, null, 2); DOMElements.settingsModal.classList.remove('hidden'); });
        DOMElements.closeSettingsBtn.addEventListener('click', () => DOMElements.settingsModal.classList.add('hidden'));
        DOMElements.connectBtn.addEventListener('click', connect);
        DOMElements.configInput.addEventListener('change', (e) => { try { config = JSON.parse(e.target.value); saveConfig(); renderUI(); } catch (err) { alert("Invalid JSON."); }});
        DOMElements.importConfigInput.addEventListener('change', (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (event) => { DOMElements.configInput.value = event.target.result; DOMElements.configInput.dispatchEvent(new Event('change')); }; reader.readAsText(file); });
        DOMElements.exportConfigBtn.addEventListener('click', () => { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(config, null, 2)); const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", "mc-web-console-config.json"); dl.click(); dl.remove(); });
        DOMElements.resetConfigBtn.addEventListener('click', () => { if (confirm("Reset to default config?")) { config = JSON.parse(JSON.stringify(defaultConfig)); saveConfig(); DOMElements.configInput.value = JSON.stringify(config, null, 2); renderUI(); }});
        DOMElements.saveScriptBtn.addEventListener('click', () => { const newName = DOMElements.scriptNameInput.value.trim(); if (!newName) { alert("Script name cannot be empty."); return; } if (editingScriptName && editingScriptName !== newName) { delete scripts[editingScriptName]; } scripts[newName] = DOMElements.scriptContentInput.value; saveScripts(); DOMElements.scriptEditorModal.classList.add('hidden'); renderScripts(); });
        DOMElements.cancelScriptBtn.addEventListener('click', () => DOMElements.scriptEditorModal.classList.add('hidden'));
        DOMElements.visualEditorBtn.addEventListener('click', () => { tempConfig = JSON.parse(JSON.stringify(config)); renderConfigEditor(); DOMElements.configEditorModal.classList.remove('hidden'); });
        DOMElements.saveConfigEditBtn.addEventListener('click', () => { config = JSON.parse(JSON.stringify(tempConfig)); saveConfig(); renderUI(); DOMElements.configEditorModal.classList.add('hidden'); });
        DOMElements.cancelConfigEditBtn.addEventListener('click', () => DOMElements.configEditorModal.classList.add('hidden'));

        DOMElements.mainContent.addEventListener('click', (e) => {
            const target = e.target.closest('button'); if (!target) return;
            if (target.classList.contains('command-btn')) sendCommand(target.dataset.command);
            if (target.classList.contains('text-input-btn')) { const input = document.getElementById(target.dataset.inputId); sendCommand(input.dataset.commandTemplate.replace('%s%', input.value)); }
            if (target.classList.contains('dropdown-btn')) { const select = document.getElementById(target.dataset.selectId); sendCommand(select.value); }
            if (target.id === 'create-script-btn') { editingScriptName = null; DOMElements.scriptEditorTitle.textContent = "Create Script"; DOMElements.scriptNameInput.value = ""; DOMElements.scriptContentInput.value = ""; DOMElements.scriptNameInput.disabled = false; DOMElements.scriptEditorModal.classList.remove('hidden'); }
            if (target.classList.contains('edit-script-btn')) { editingScriptName = target.dataset.scriptName; DOMElements.scriptEditorTitle.textContent = `Edit Script: ${editingScriptName}`; DOMElements.scriptNameInput.value = editingScriptName; DOMElements.scriptContentInput.value = scripts[editingScriptName]; DOMElements.scriptNameInput.disabled = true; DOMElements.scriptEditorModal.classList.remove('hidden'); }
            if (target.classList.contains('delete-script-btn')) { const name = target.dataset.scriptName; if (confirm(`Delete script "${name}"?`)) { delete scripts[name]; saveScripts(); renderScripts(); }}
            if (target.classList.contains('run-script-btn')) runScript(target.dataset.scriptName);
        });
        DOMElements.mainContent.addEventListener('change', (e) => { if (e.target.classList.contains('toggle-input')) sendCommand(e.target.checked ? e.target.dataset.onCommand : e.target.dataset.offCommand); });
        const handleSliderRelease = (e) => { if (e.target.classList.contains('slider-input')) sendCommand(e.target.dataset.commandTemplate.replace('%s%', e.target.value)); };
        DOMElements.mainContent.addEventListener('mouseup', handleSliderRelease); DOMElements.mainContent.addEventListener('touchend', handleSliderRelease);
        DOMElements.mainContent.addEventListener('input', (e) => { if (e.target.classList.contains('slider-input')) document.getElementById(e.target.id + '-value').textContent = e.target.value; });

        // =================================================================================
        // --- VISUAL CONFIG EDITOR LOGIC ---
        // =================================================================================
        const itemTemplates = {
            text: { type: 'text', content: 'Some text' }, button: { type: 'button', label: 'My Button', command: '/say hello' },
            text_input: { type: 'text_input', label: 'Run', placeholder: 'message', command: '/say %s%' },
            toggle: { type: 'toggle', label: 'My Toggle', on_command: '/gamerule doDaylightCycle true', off_command: '/gamerule doDaylightCycle false' },
            dropdown: { type: 'dropdown', options: [{ label: 'Option 1', command: '/cmd1' }, { label: 'Option 2', command: '/cmd2' }] },
            slider: { type: 'slider', label: 'My Slider', min: 0, max: 100, default: 50, command: '/xp %s%L @p' }
        };
        const itemFields = {
            text: ['content'], button: ['label', 'command'], text_input: ['label', 'placeholder', 'command'],
            toggle: ['label', 'on_command', 'off_command'], dropdown: ['options'], slider: ['label', 'min', 'max', 'default', 'command']
        };

        function syncTempConfigToJson() { DOMElements.configInput.value = JSON.stringify(tempConfig, null, 2); }

        function generateItemEditorHtml(item, tI, pI, iI) {
            let fieldsHtml = itemFields[item.type].map(field => {
                if (field === 'options') {
                    return `<div class="col-span-2"><label class="block text-sm">Options</label><div class="space-y-1 mt-1">${item.options.map((opt, oI) => `<div class="flex items-center space-x-1"><input class="flex-grow p-1 bg-gray-800 rounded" type="text" placeholder="Label" data-ti="${tI}" data-pi="${pI}" data-ii="${iI}" data-oi="${oI}" data-key="label" value="${opt.label}"><input class="flex-grow p-1 bg-gray-800 rounded" type="text" placeholder="Command" data-ti="${tI}" data-pi="${pI}" data-ii="${iI}" data-oi="${oI}" data-key="command" value="${opt.command}"><button class="p-1 bg-red-600 rounded config-delete-option-btn" data-ti="${tI}" data-pi="${pI}" data-ii="${iI}" data-oi="${oI}">-</button></div>`).join('')}</div><button class="text-sm mt-1 p-1 bg-green-600 rounded config-add-option-btn" data-ti="${tI}" data-pi="${pI}" data-ii="${iI}">+ Add Option</button></div>`;
                }
                return `<div><label class="block text-sm capitalize">${field.replace('_', ' ')}</label><input class="w-full p-1 bg-gray-800 rounded" type="text" data-ti="${tI}" data-pi="${pI}" data-ii="${iI}" data-key="${field}" value="${item[field] || ''}"></div>`;
            }).join('');
            return `<div class="p-2 border border-gray-600 rounded"><div class="grid grid-cols-2 gap-2">${fieldsHtml}</div></div>`;
        }

        function renderConfigEditor() {
            const content = DOMElements.configEditorContent;
            let themeHtml = `<section><h3 class="text-lg font-semibold mb-2">Theme Colors</h3><div class="grid grid-cols-2 md:grid-cols-4 gap-4">${Object.keys(tempConfig.theme).map(key => `<div><label class="block text-sm capitalize">${key.replace(/([A-Z])/g, ' $1')}</label><input type="color" data-theme-key="${key}" value="${tempConfig.theme[key]}" class="w-full h-10 p-1 bg-gray-700 border border-gray-600 rounded-md cursor-pointer"></div>`).join('')}</div></section>`;

            let tabsHtml = tempConfig.tabs.filter(t => t.id !== 'console' && t.id !== 'scripts').map((tab, tabIndex) => {
                const tI = tempConfig.tabs.findIndex(t => t.id === tab.id); // Get true index
                let panelsHtml = tab.panels?.map((panel, pI) => {
                    let itemsHtml = panel.items?.map((item, iI) => `
                            <details class="bg-gray-800 rounded mt-1"><summary class="p-2 cursor-pointer flex justify-between items-center"><span>Item: <strong>${item.label || item.type}</strong></span><div class="flex items-center space-x-1"><select class="p-1 text-sm bg-gray-700 rounded config-item-type-select" data-ti="${tI}" data-pi="${pI}" data-ii="${iI}">${Object.keys(itemTemplates).map(type => `<option value="${type}" ${item.type === type ? 'selected' : ''}>${type}</option>`).join('')}</select><button class="p-1 bg-red-600 rounded config-delete-item-btn" data-ti="${tI}" data-pi="${pI}" data-ii="${iI}"><span class="material-icons text-sm">delete</span></button></div></summary><div class="p-2 border-t border-gray-600">${generateItemEditorHtml(item, tI, pI, iI)}</div></details>`).join('') || '';
                    return `<details class="bg-gray-700 rounded mt-2"><summary class="p-2 cursor-pointer flex justify-between items-center"><div><span class="material-icons text-sm summary-arrow">arrow_right</span> Panel: <input class="bg-transparent font-bold" type="text" data-ti="${tI}" data-pi="${pI}" data-key="title" value="${panel.title}"></div><button class="p-1 bg-red-600 rounded config-delete-panel-btn" data-ti="${tI}" data-pi="${pI}"><span class="material-icons text-sm">delete</span></button></summary><div class="p-2 border-t border-gray-500">${itemsHtml}<button class="mt-2 text-sm p-1 bg-green-600 rounded config-add-item-btn" data-ti="${tI}" data-pi="${pI}">+ Add Item</button></div></details>`;
                }).join('') || '';
                return `<details class="bg-gray-600 rounded"><summary class="p-2 cursor-pointer flex justify-between items-center"><div><span class="material-icons text-sm summary-arrow">arrow_right</span> Tab: <input class="bg-transparent font-bold" type="text" data-ti="${tI}" data-key="name" value="${tab.name}"> Icon: <input class="bg-transparent w-24" type="text" data-ti="${tI}" data-key="icon" value="${tab.icon}"></div><button class="p-1 bg-red-600 rounded config-delete-tab-btn" data-ti="${tI}"><span class="material-icons text-sm">delete</span></button></summary><div class="p-2 border-t border-gray-500">${panelsHtml}<button class="mt-2 text-sm p-1 bg-blue-600 rounded config-add-panel-btn" data-ti="${tI}">+ Add Panel</button></div></details>`;
            }).join('');
            content.innerHTML = `${themeHtml}<section><h3 class="text-lg font-semibold mb-2">Tabs</h3><div class="space-y-2">${tabsHtml}</div><button class="mt-2 text-sm p-1 bg-green-600 rounded config-add-tab-btn">+ Add Tab</button></section>`;
        }

        DOMElements.configEditorContent.addEventListener('input', (e) => { // Use input for live updates
            const { ti, pi, ii, oi, key, themeKey } = e.target.dataset;
            if (themeKey) tempConfig.theme[themeKey] = e.target.value;
            if (ti && key && !pi) tempConfig.tabs[ti][key] = e.target.value;
            if (ti && pi && key && !ii) tempConfig.tabs[ti].panels[pi][key] = e.target.value;
            if (ti && pi && ii && key && !oi) tempConfig.tabs[ti].panels[pi].items[ii][key] = e.target.value;
            if (ti && pi && ii && oi && key) tempConfig.tabs[ti].panels[pi].items[ii].options[oi][key] = e.target.value;
            syncTempConfigToJson();
        });
        DOMElements.configEditorContent.addEventListener('change', (e) => {
            if (e.target.classList.contains('config-item-type-select')) {
                const { ti, pi, ii } = e.target.dataset;
                const newType = e.target.value;
                tempConfig.tabs[ti].panels[pi].items[ii] = JSON.parse(JSON.stringify(itemTemplates[newType]));
                renderConfigEditor(); syncTempConfigToJson();
            }
        });
        DOMElements.configEditorContent.addEventListener('click', (e) => {
            const button = e.target.closest('button'); if (!button) return;
            const { ti, pi, ii, oi } = button.dataset;
            if (button.classList.contains('config-add-tab-btn')) tempConfig.tabs.push({ id: `custom_${Date.now()}`, name: "New Tab", icon: "label", panels: [] });
            if (button.classList.contains('config-delete-tab-btn')) if (confirm("Delete tab?")) tempConfig.tabs.splice(ti, 1);
            if (button.classList.contains('config-add-panel-btn')) tempConfig.tabs[ti].panels.push({ title: "New Panel", items: [] });
            if (button.classList.contains('config-delete-panel-btn')) if (confirm("Delete panel?")) tempConfig.tabs[ti].panels.splice(pi, 1);
            if (button.classList.contains('config-add-item-btn')) tempConfig.tabs[ti].panels[pi].items.push(JSON.parse(JSON.stringify(itemTemplates.text)));
            if (button.classList.contains('config-delete-item-btn')) if (confirm("Delete item?")) tempConfig.tabs[ti].panels[pi].items.splice(ii, 1);
            if (button.classList.contains('config-add-option-btn')) tempConfig.tabs[ti].panels[pi].items[ii].options.push({ label: 'New', command: '/cmd' });
            if (button.classList.contains('config-delete-option-btn')) tempConfig.tabs[ti].panels[pi].items[ii].options.splice(oi, 1);
            renderConfigEditor(); syncTempConfigToJson();
        });

        // =================================================================================
        // --- INITIALIZATION ---
        // =================================================================================
        initialize();
    });
</script>
</body>
</html>
